# .github/workflows/ci.yml
# Continuous Integration Pipeline for AI_FREELANCE_AUTOMATION
# Ensures 100% code quality, security, and reliability before any merge

name: ğŸ§ª CI â€” Autonomous Quality Assurance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger for emergency checks

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.8.3"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. SECURITY & DEPENDENCY SCAN
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-scan:
    name: ğŸ”’ Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        run: |
          pip install poetry==${{ env.POETRY_VERSION }}
          poetry config virtualenvs.in-project true

      - name: ğŸ” Install Dependencies
        run: poetry install --no-interaction --no-root

      - name: ğŸ•µï¸â€â™‚ï¸ Dependency Review (GitHub-native)
        uses: actions/dependency-review-action@v4

      - name: ğŸ›¡ï¸ Secret Scanning (pre-commit)
        run: |
          if command -v detect-secrets >/dev/null; then
            detect-secrets scan --baseline .secrets.baseline
          else
            echo "âš ï¸ detect-secrets not installed â€” skipping"
          fi

      - name: ğŸ“Š Safety Check (CVE in deps)
        run: poetry run safety check --full-report

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. CODE QUALITY & STYLE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  code-quality:
    name: ğŸ§¼ Code Quality & Style Enforcement
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        run: |
          pip install poetry==${{ env.POETRY_VERSION }}
          poetry config virtualenvs.in-project true

      - name: ğŸ” Install Dependencies
        run: poetry install --no-interaction

      - name: ğŸ§¹ Linting (ruff)
        run: poetry run ruff check .

      - name: ğŸ¨ Formatting Check (ruff format --check)
        run: poetry run ruff format --check .

      - name: ğŸ“ Type Checking (mypy)
        run: poetry run mypy .

      - name: ğŸ“š Docstring Validation (pydocstyle)
        run: poetry run pydocstyle core/ services/ plugins/

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. UNIT & INTEGRATION TESTS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tests:
    name: ğŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install Poetry
        run: |
          pip install poetry==${{ env.POETRY_VERSION }}
          poetry config virtualenvs.in-project true

      - name: ğŸ” Install Dependencies + Dev
        run: poetry install --no-interaction --with dev

      - name: ğŸ§ª Run Tests with Coverage
        run: |
          poetry run pytest \
            --cov=core \
            --cov=services \
            --cov=plugins \
            --cov-report=xml \
            --cov-report=term-missing \
            -v

      - name: ğŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. CONFIGURATION & STRUCTURE VALIDATION
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  structure-validation:
    name: ğŸ—‚ï¸ Project Structure & Config Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âœ… Validate Directory Structure
        run: |
          # Ensure critical directories exist
          test -d core || { echo "âŒ Missing 'core/'"; exit 1; }
          test -d services || { echo "âŒ Missing 'services/'"; exit 1; }
          test -d plugins || { echo "âŒ Missing 'plugins/'"; exit 1; }
          test -f pyproject.toml || { echo "âŒ Missing pyproject.toml"; exit 1; }

      - name: ğŸ§© Validate JSON Schemas (if any)
        run: |
          if [ -d schemas ]; then
            find schemas -name "*.json" -exec python -m json.tool {} \; > /dev/null
          fi

      - name: ğŸ” Validate Secrets Are Not Committed
        run: |
          ! git grep -i "password\|secret\|token\|key" -- '*.py' '*.yml' '*.yaml' '*.json' || {
            echo "âŒ Hardcoded secrets detected!"; exit 1;
          }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. FINAL APPROVAL (all jobs must pass)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approve:
    name: âœ… CI Passed â€” Ready for Merge
    needs: [security-scan, code-quality, tests, structure-validation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸŸ¢ All checks passed!
        run: echo "âœ… Autonomous CI pipeline completed successfully."