# AI_FREELANCE_AUTOMATION/docker-compose.monitoring.yml
#
# ğŸ“Š Monitoring Stack for AI Freelance Automation System
# Includes Prometheus (metrics), Grafana (dashboards), Loki (logs), Tempo (traces)
# Designed for 99.9% uptime, secure inter-service communication, and scalability.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d

version: '3.8'

services:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ” Prometheus â€” Metrics Collection & Alerting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prometheus:
    image: prom/prometheus:v2.47.1
    container_name: ai_freelance_prometheus
    restart: unless-stopped
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=30d'
    ports:
      - "9090:9090"
    networks:
      - monitoring_net
    labels:
      org.ai-freelance.description: "Prometheus metrics collector"
      org.ai-freelance.security: "isolated"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“ˆ Grafana â€” Visualization & Dashboards
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  grafana:
    image: grafana/grafana:10.1.5
    container_name: ai_freelance_grafana
    restart: unless-stopped
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-secure_password_change_in_prod}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/"
    ports:
      - "3000:3000"
    networks:
      - monitoring_net
    depends_on:
      - prometheus
    labels:
      org.ai-freelance.description: "Grafana monitoring dashboard"
      org.ai-freelance.security: "auth_required"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“œ Loki â€” Log Aggregation (LogQL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loki:
    image: grafana/loki:2.9.2
    container_name: ai_freelance_loki
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs:ro  # Mount app logs for ingestion
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    networks:
      - monitoring_net
    labels:
      org.ai-freelance.description: "Loki log aggregation system"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ•µï¸ Tempo â€” Distributed Tracing (OpenTelemetry)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tempo:
    image: grafana/tempo:2.2.1
    container_name: ai_freelance_tempo
    restart: unless-stopped
    volumes:
      - ./docker/tempo/tempo.yaml:/etc/tempo.yaml:ro
    command: [ "-config.file=/etc/tempo.yaml" ]
    ports:
      - "14268"   # jaeger thrift
      - "3200"    # tempo http
      - "4317"    # otlp grpc
      - "4318"    # otlp http
    networks:
      - monitoring_net
    labels:
      org.ai-freelance.description: "Tempo distributed tracing backend"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“¡ Pushgateway â€” For batch job metrics (optional but recommended)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pushgateway:
    image: prom/pushgateway:v1.6.0
    container_name: ai_freelance_pushgateway
    restart: unless-stopped
    ports:
      - "9091:9091"
    networks:
      - monitoring_net
    labels:
      org.ai-freelance.description: "Pushgateway for ephemeral job metrics"

networks:
  monitoring_net:
    driver: bridge
    name: ai_freelance_monitoring_net
    internal: false  # Allow external access to Grafana/Prometheus if needed

volumes:
  prometheus_data:
    name: ai_freelance_prometheus_data
  grafana_data:
    name: ai_freelance_grafana_data

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ’¡ Notes:
# - All services are isolated in `monitoring_net`
# - Logs from `./logs/` are automatically ingested by Loki
# - Use `.env` to override credentials securely
# - Never expose Grafana/Prometheus publicly without auth + TLS
# - For production: add reverse proxy (nginx) with HTTPS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€