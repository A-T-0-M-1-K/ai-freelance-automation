# AI_FREELANCE_AUTOMATION - Docker Compose for Production
# Designed for high availability, security, and scalability.
# Uses Traefik as reverse proxy with automatic Let's Encrypt SSL.

version: '3.8'

services:
  # ----------------------------
  # TRAEFIK (Reverse Proxy + Automatic HTTPS)
  # ----------------------------
  traefik:
    image: traefik:v2.10
    container_name: ai_freelance_traefik_prod
    restart: unless-stopped
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${ADMIN_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard (protected by auth)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme:/acme
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${MONITORING_HOST}`)"
      - "traefik.http.routers.api.service=api@internal"
      - "traefik.http.routers.api.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${DASHBOARD_AUTH}"

  # ----------------------------
  # Core Application (Production Build)
  # ----------------------------
  app:
    image: ghcr.io/your-org/ai-freelance-automation:latest
    container_name: ai_freelance_app_prod
    restart: unless-stopped
    environment:
      - ENV=production
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      - DB_URL=postgresql://produser:${DB_PASSWORD}@db:5432/ai_freelance_prod
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`${APP_HOST}`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      - "traefik.http.services.app.loadbalancer.server.port=8000"
    depends_on:
      - db
      - redis
      - minio
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ----------------------------
  # Celery Worker (Scalable)
  # ----------------------------
  worker:
    image: ghcr.io/your-org/ai-freelance-automation:latest
    container_name: ai_freelance_worker_prod
    command: celery -A worker.celery_app worker --loglevel=info --concurrency=4
    environment:
      - ENV=production
      - DB_URL=postgresql://produser:${DB_PASSWORD}@db:5432/ai_freelance_prod
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    deploy:
      replicas: 3

  # ----------------------------
  # PostgreSQL (Production DB)
  # ----------------------------
  db:
    image: postgres:15
    container_name: ai_freelance_db_prod
    environment:
      POSTGRES_DB: ai_freelance_prod
      POSTGRES_USER: produser
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U produser -d ai_freelance_prod"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ----------------------------
  # Redis (Production Cache & Queue)
  # ----------------------------
  redis:
    image: redis:7
    container_name: ai_freelance_redis_prod
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data_prod:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ----------------------------
  # MinIO (S3-compatible Storage)
  # ----------------------------
  minio:
    image: minio/minio:latest
    container_name: ai_freelance_minio_prod
    ports:
      - "9000"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    volumes:
      - minio_data_prod:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ----------------------------
  # Prometheus + Grafana (Monitoring)
  # ----------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: ai_freelance_prometheus_prod
    volumes:
      - ./prometheus/prometheus.prod.yml:/etc/prometheus/prometheus.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prom.rule=Host(`prom.${MONITORING_HOST}`)"
      - "traefik.http.routers.prom.entrypoints=websecure"
      - "traefik.http.routers.prom.tls.certresolver=letsencrypt"
    depends_on:
      - traefik

  grafana:
    image: grafana/grafana:latest
    container_name: ai_freelance_grafana_prod
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: https://grafana.${MONITORING_HOST}
    volumes:
      - grafana_data_prod:/var/lib/grafana
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${MONITORING_HOST}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"

  # ----------------------------
  # Backup Service (Periodic)
  # ----------------------------
  backup:
    image: ghcr.io/your-org/ai-freelance-backup:latest
    container_name: ai_freelance_backup_prod
    environment:
      DB_HOST: db
      DB_NAME: ai_freelance_prod
      DB_USER: produser
      DB_PASSWORD: ${DB_PASSWORD}
      S3_BUCKET: backups
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    volumes:
      - ./backup/scripts:/scripts:ro
    deploy:
      restart_policy:
        condition: on-failure

volumes:
  postgres_data_prod:
  redis_data_prod:
  minio_data_prod:
  grafana_data_prod:

networks:
  default:
    name: ai_freelance_prod_network