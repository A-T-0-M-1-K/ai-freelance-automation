# tox.ini â€” Multi-environment testing and quality assurance for AI_FREELANCE_AUTOMATION
# Ensures consistency across dev, CI, and production environments.
# Supports linting, type checking, security scanning, unit/integration tests, and docs.

[tox]
# Supported Python versions (aligned with project requirements)
envlist =
    py310, py311, py312,
    lint,
    typecheck,
    security,
    docs-build,
    coverage-report

# Isolated build using PEP 517
isolated_build = true

# Skip missing interpreters (e.g., if py312 not installed locally)
skip_missing_interpreters = true

[testenv]
# Base dependencies for all test environments
deps =
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    pytest-mock>=3.12.0
    httpx>=0.25.0
    aiofiles>=23.2.1

# Common test command with coverage
commands =
    pytest {posargs:tests/} \
        --tb=short \
        --asyncio-mode=auto \
        --cov=core --cov=services --cov=plugins --cov=utils \
        --cov-report=term-missing \
        --cov-fail-under=85

# Environment variables for tests
setenv =
    PYTHONPATH = {toxinidir}
    ENV = test
    LOG_LEVEL = WARNING

# Exclude heavy dependencies in minimal envs
extras = test

[testenv:lint]
description = Run code style and quality checks
deps =
    ruff>=0.4.0
    black>=24.0.0
    isort>=5.13.0
    flake8>=7.0.0
skip_install = true
commands =
    ruff check core/ services/ plugins/ utils/ tests/
    black --check --diff core/ services/ plugins/ utils/ tests/
    isort --check --diff core/ services/ plugins/ utils/ tests/

[testenv:typecheck]
description = Run static type checking
deps =
    mypy>=1.8.0
    types-requests
    types-aiofiles
skip_install = false
commands =
    mypy core/ services/ plugins/ utils/ --strict --namespace-packages

[testenv:security]
description = Scan for security vulnerabilities
deps =
    bandit>=1.7.8
    safety>=2.4.0
skip_install = true
commands =
    bandit -r core/ services/ plugins/ -s B101,B104,B605
    safety check --full-report

[testenv:docs-build]
description = Build documentation
deps =
    sphinx>=7.2.0
    sphinx-rtd-theme>=2.0.0
    myst-parser>=3.0.0
changedir = docs
commands =
    sphinx-build -b html source build/html
    sphinx-build -b linkcheck source build/linkcheck

[testenv:coverage-report]
description = Generate detailed coverage report
deps = pytest-cov
skip_install = false
commands =
    pytest tests/ --cov=core --cov=services --cov=plugins --cov=utils --cov-report=html --cov-report=xml

# Optional: Performance benchmarking (uncomment if needed)
# [testenv:benchmark]
# deps = pytest-benchmark
# commands = pytest tests/benchmarks/ --benchmark-only

# Optional: Integration test against real platforms (mocked by default)
# [testenv:integration]
# setenv =
#     ENV = integration
#     PLATFORM_API_MOCK = false
# commands = pytest tests/integration/ --integration
